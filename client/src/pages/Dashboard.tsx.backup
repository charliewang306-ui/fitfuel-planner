import { useQuery, useMutation } from "@tanstack/react-query";
import { CircularProgress } from "@/components/CircularProgress";
import { MacroBar } from "@/components/MacroBar";
import { CheatLine } from "@/components/CheatLine";
import { NutritionGuideCard } from "@/components/NutritionGuideCard";
import { WeeklyTrendsCard } from "@/components/WeeklyTrendsCard";
import { ProteinPowderQuickAdd } from "@/components/ProteinPowderQuickAdd";
import { AdBanner } from "@/components/AdBanner";
import { TDEECalculationCard } from "@/components/TDEECalculationCard";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Sparkles, Droplets, Beef, Flame, Wheat, Apple, Loader2, TrendingUp, TrendingDown, Minus, Lock, Scale, Settings, ChevronDown, ChevronUp, RefreshCw, MessageCircle } from "lucide-react";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { useToast } from "@/hooks/use-toast";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { useSubscription } from "@/hooks/use-subscription";
import type { UserProfile, CheckinWeight } from "@shared/schema";
import { Link } from "wouter";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";
import { Progress } from "@/components/ui/progress";
import { useState, useEffect } from "react";
import { useTranslation } from "react-i18next";

interface Summary {
  target: {
    kcal: number;
    proteinG: number;
    fatG: number;
    carbsG: number;
    fiberG: number;
    waterOz: number;
    // Micronutrients
    sodiumMg?: number;
    vitaminAMcg?: number;
    vitaminCMg?: number;
    vitaminDMcg?: number;
    vitaminEMg?: number;
    vitaminKMcg?: number;
    vitaminB12Mcg?: number;
    calciumMg?: number;
    ironMg?: number;
    magnesiumMg?: number;
    zincMg?: number;
    potassiumMg?: number;
  };
  current: {
    kcal: number;
    proteinG: number;
    fatG: number;
    carbsG: number;
    fiberG: number;
    waterOz: number;
    // Micronutrients
    sodiumMg?: number;
    vitaminAMcg?: number;
    vitaminCMg?: number;
    vitaminDMcg?: number;
    vitaminEMg?: number;
    vitaminKMcg?: number;
    vitaminB12Mcg?: number;
    calciumMg?: number;
    ironMg?: number;
    magnesiumMg?: number;
    zincMg?: number;
    potassiumMg?: number;
  };
  remaining: {
    kcal: number;
    proteinG: number;
    fatG: number;
    carbsG: number;
    fiberG: number;
    waterOz: number;
    // Micronutrients
    sodiumMg?: number;
    vitaminAMcg?: number;
    vitaminCMg?: number;
    vitaminDMcg?: number;
    vitaminEMg?: number;
    vitaminKMcg?: number;
    vitaminB12Mcg?: number;
    calciumMg?: number;
    ironMg?: number;
    magnesiumMg?: number;
    zincMg?: number;
    potassiumMg?: number;
  };
}

interface SuggestionCombo {
  name: string;
  foods: Array<{
    foodName: string;
    amountG: number;
    kcal: number;
    proteinG: number;
    fatG: number;
    carbsG: number;
    fiberG: number;
    reason: string;
  }>;
  totalKcal: number;
  totalProteinG: number;
  totalFatG: number;
  totalCarbsG: number;
  totalFiberG: number;
  deviation: {
    kcal: number;
    proteinG: number;
    fatG: number;
    carbsG: number;
  };
}

export default function Dashboard() {
  const { t, i18n } = useTranslation(['dashboard', 'common']);
  const { toast } = useToast();
  const { isPro } = useSubscription();
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [suggestions, setSuggestions] = useState<SuggestionCombo[]>([]);
  const [dailyAIUsage, setDailyAIUsage] = useState(0);
  const [showWeightModal, setShowWeightModal] = useState(false);
  const [weightInput, setWeightInput] = useState("");
  const [weightUnit, setWeightUnit] = useState<"lb" | "kg">("lb");
  const [showMicronutrients, setShowMicronutrients] = useState(false);
  const [savedRemaining, setSavedRemaining] = useState<any>(null); // Save remaining data for regeneration
  const today = new Date().toISOString().split('T')[0];
  
  // Track daily AI usage for free users
  useEffect(() => {
    const usageKey = `ai_suggestions_${today}`;
    const usage = parseInt(localStorage.getItem(usageKey) || '0');
    setDailyAIUsage(usage);
  }, [today]);

  // Fetch user profile for goal display
  const { data: profile } = useQuery<UserProfile>({
    queryKey: ['/api/profile']
  });

  // Fetch today's summary
  const { data: summary, isLoading } = useQuery<Summary>({
    queryKey: ['/api/summary/today']
  });

  // Check if weight was logged today
  const { data: todayWeight } = useQuery<CheckinWeight | null>({
    queryKey: ['/api/weights/today'],
    queryFn: async () => {
      const res = await fetch(`/api/weights/check/${today}`);
      if (!res.ok) return null;
      return res.json();
    }
  });

  // AI suggestions mutation
  const suggestMutation = useMutation({
    mutationFn: async (remaining: any) => {
      const res = await apiRequest('POST', '/api/suggest', remaining);
      return res.json();
    },
    onSuccess: (data: SuggestionCombo[], variables) => {
      setSuggestions(data);
      setShowSuggestions(true);
      // Save remaining data on first successful generation (for regeneration)
      // Only save if not already saved to preserve initial state
      if (!savedRemaining) {
        setSavedRemaining(variables);
      }
    },
    onError: () => {
      toast({
        title: t('dashboard:generateFailed'),
        description: t('dashboard:generateFailedDesc'),
        variant: 'destructive'
      });
    }
  });

  // Log combo mutation (batch logs all foods in a suggestion)
  const logComboMutation = useMutation({
    mutationFn: async (combo: SuggestionCombo) => {
      // Log each food in the combo sequentially
      for (const food of combo.foods) {
        // Need to find the food ID from the database by name
        // For now, we'll create the food if it doesn't exist
        const searchRes = await apiRequest('GET', `/api/foods/search?q=${encodeURIComponent(food.foodName)}`);
        const searchResults = await searchRes.json();
        
        let foodId: string;
        if (searchResults.length > 0 && searchResults[0].name === food.foodName) {
          foodId = searchResults[0].id;
        } else {
          // Food doesn't exist, create it
          const createRes = await apiRequest('POST', '/api/foods', {
            name: food.foodName,
            kcal100g: (food.kcal / food.amountG) * 100,
            protein100g: (food.proteinG / food.amountG) * 100,
            fat100g: (food.fatG / food.amountG) * 100,
            carbs100g: (food.carbsG / food.amountG) * 100,
            fiber100g: (food.fiberG / food.amountG) * 100,
            perUnitType: 'per100g' as const
          });
          const createdFood = await createRes.json();
          foodId = createdFood.id;
        }
        
        // Log the food
        await apiRequest('POST', '/api/foodlog', {
          foodId,
          amountValue: food.amountG,
          amountUnit: 'g' as const
        });
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/summary/today'] });
      queryClient.invalidateQueries({ queryKey: ['/api/foodlogs/today'] });
      // Close dialog and reset state
      setShowSuggestions(false);
      setSavedRemaining(null); // Reset to allow fresh data next time
      toast({
        title: t('dashboard:logSuccess'),
        description: t('dashboard:logSuccessDesc')
      });
    },
    onError: () => {
      toast({
        title: t('dashboard:logFailed'),
        description: t('dashboard:logFailedDesc'),
        variant: 'destructive'
      });
    }
  });

  // Weight logging mutation
  const logWeightMutation = useMutation({
    mutationFn: async (data: { weightLb: number }) => {
      const res = await apiRequest('POST', '/api/weights', {
        date: today,
        weightLb: data.weightLb
      });
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/weights/today'] });
      queryClient.invalidateQueries({ queryKey: ['/api/weights'] });
      queryClient.invalidateQueries({ queryKey: ['/api/profile'] });
      setShowWeightModal(false);
      setWeightInput("");
      toast({
        title: t('dashboard:weightLogged'),
        description: t('dashboard:weightLoggedDesc')
      });
    },
    onError: (error: Error) => {
      toast({
        title: t('dashboard:weightLogFailed'),
        description: error.message,
        variant: "destructive"
      });
    }
  });

  const handleLogWeight = () => {
    const weight = parseFloat(weightInput);
    if (isNaN(weight) || weight <= 0) {
      toast({
        title: t('dashboard:invalidInput'),
        description: t('dashboard:invalidInputDesc'),
        variant: "destructive"
      });
      return;
    }
    
    // Convert to pounds if input is in kg
    const weightLb = weightUnit === "kg" ? weight * 2.20462 : weight;
    logWeightMutation.mutate({ weightLb });
  };

  const handleFillRemaining = () => {
    if (!summary) return;
    
    // PRO gating: Enforce AI suggestion limits
    if (!isPro) {
      // Check daily usage from localStorage (simple client-side tracking)
      const usageKey = `ai_suggestions_${today}`;
      const usage = parseInt(localStorage.getItem(usageKey) || '0');
      
      if (usage >= 3) {
        toast({
          title: t('dashboard:dailyLimitReached'),
          description: t('dashboard:dailyLimitReachedDesc'),
          variant: 'destructive'
        });
        return;
      }
      
      // Increment usage counter
      localStorage.setItem(usageKey, String(usage + 1));
      setDailyAIUsage(usage + 1);
    }
    
    // Trigger AI generation
    suggestMutation.mutate(summary.remaining);
  };
  
  // Regenerate suggestions using saved remaining data (PRO only)
  const handleRegenerateSuggestions = () => {
    // PRO gating: Feature only available for Pro users
    if (!isPro) {
      toast({
        title: "PRO 功能",
        description: "换一组建议是 PRO 专属功能，升级 PRO 解锁无限使用",
        variant: 'destructive'
      });
      return;
    }
    
    if (!savedRemaining) {
      toast({
        title: "无法重新生成",
        description: "没有保存的营养数据，请重新打开对话框",
        variant: 'destructive'
      });
      return;
    }
    
    // Regenerate using saved remaining data
    suggestMutation.mutate(savedRemaining);
  };
  
  // Handle dialog open/close and reset state when closed
  const handleDialogOpenChange = (open: boolean) => {
    setShowSuggestions(open);
    if (!open) {
      // Reset savedRemaining when dialog closes
      setSavedRemaining(null);
    }
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!summary) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <p className="text-muted-foreground">加载失败</p>
      </div>
    );
  }

  const { target, current, remaining } = summary;

  // Goal display helpers
  const getGoalBadge = (goal: string) => {
    switch (goal) {
      case 'cut':
        return { icon: <TrendingDown className="w-3 h-3" />, text: '减脂', variant: 'destructive' as const };
      case 'bulk':
        return { icon: <TrendingUp className="w-3 h-3" />, text: '增肌', variant: 'default' as const };
      default:
        return { icon: <Minus className="w-3 h-3" />, text: '维持', variant: 'secondary' as const };
    }
  };

  const getGoalDescription = (goal: string) => {
    switch (goal) {
      case 'cut':
        return '高蛋白低热量 (2.2g/kg) 保护肌肉';
      case 'bulk':
        return '高蛋白高热量 (1.9g/kg) 促进增肌';
      default:
        return '适中蛋白 (1.8g/kg) 维持体态';
    }
  };

  const goalInfo = profile ? getGoalBadge(profile.goal) : null;

  return (
    <div className="flex flex-col min-h-screen bg-background pb-20">
      {/* Header */}
      <header className="sticky top-0 z-40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border">
        <div className="flex items-center justify-between px-4 h-14">
          <div className="flex items-center gap-2">
            <h1 className="text-xl font-semibold text-foreground">{t('dashboard:title')}</h1>
            {goalInfo && (
              <Badge variant={goalInfo.variant} className="text-xs flex items-center gap-1" data-testid="badge-goal-mode">
                {goalInfo.icon}
                {goalInfo.text}
              </Badge>
            )}
          </div>
          <div className="text-sm text-muted-foreground">
            {new Date().toLocaleDateString(i18n.language, { month: 'long', day: 'numeric' })}
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1 px-4 py-6 space-y-8">
        {/* CheatLine - Quick Reference */}
        {profile && <CheatLine weightLb={profile.weightLb} goal={profile.goal} />}
        
        {/* TDEE Calculation Details */}
        {profile && summary && (
          <TDEECalculationCard 
            profile={profile} 
            targetKcal={summary.target.kcal}
          />
        )}
        
        {/* Target Calculation Info */}
        {profile && (
          <Card className="bg-primary/5 border-primary/20">
            <CardContent className="p-4">
              <div className="flex items-start justify-between mb-2">
                <p className="text-sm font-medium text-foreground">
                  你的每日营养目标
                </p>
                <div className="flex items-center gap-2">
                  <Badge variant="outline" className="text-xs">
                    {profile.goal === 'cut' ? '减脂模式' : profile.goal === 'bulk' ? '增肌模式' : '维持模式'}
                  </Badge>
                  <Link href="/settings">
                    <Button 
                      variant="ghost" 
                      size="sm" 
                      className="h-7 px-2"
                      data-testid="button-edit-profile"
                    >
                      <Settings className="w-3.5 h-3.5 mr-1" />
                      编辑
                    </Button>
                  </Link>
                </div>
              </div>
              <p className="text-xs text-muted-foreground mb-2">
                {getGoalDescription(profile.goal)}
              </p>
              <p className="text-xs text-muted-foreground leading-relaxed">
                基于体重 {profile.weightLb}lb ({(profile.weightLb * 0.453592).toFixed(1)}kg)：<br />
                • 热量 = 体重 × 活动系数 {profile.goal === 'cut' ? '- 400 (减脂)' : profile.goal === 'bulk' ? '+ 300 (增肌)' : '(维持)'}<br />
                • 蛋白质 = {(profile.weightLb * 0.453592).toFixed(1)}kg × {profile.goal === 'cut' ? '2.2g' : profile.goal === 'bulk' ? '1.9g' : '1.8g'} = {target.proteinG}g<br />
                • 脂肪 = 体重 × 0.35g = {target.fatG}g<br />
                • 碳水 = 剩余热量 ÷ 4 = {target.carbsG}g<br />
                • 纤维 = 14g/1000kcal = {target.fiberG}g<br />
                • 饮水 = 体重 × 0.6oz = {target.waterOz}oz
              </p>
            </CardContent>
          </Card>
        )}

        {/* Nutrition Guide Card - NEW */}
        {profile && <NutritionGuideCard goal={profile.goal} weightLb={profile.weightLb} />}

        {/* Weekly Trends Card - NEW */}
        <WeeklyTrendsCard />

        {/* AI Meal Plan Card - NEW */}
        <Link href="/ai-meal-planner">
          <Card className="bg-gradient-to-br from-purple-500/10 to-pink-500/10 border-purple-500/30 cursor-pointer hover-elevate active-elevate-2" data-testid="card-ai-meal">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-full bg-purple-500/20">
                    <Sparkles className="w-5 h-5 text-purple-600 dark:text-purple-400" />
                  </div>
                  <div>
                    <p className="text-sm font-medium text-foreground">{t('dashboard:ai_meal_plan.title')}</p>
                    <p className="text-xs text-muted-foreground">{t('dashboard:ai_meal_plan.subtitle')}</p>
                  </div>
                </div>
                <Button 
                  size="sm" 
                  variant="secondary"
                  className="pointer-events-none"
                  data-testid="button-ai-meal-cta"
                >
                  {t('dashboard:ai_meal_plan.cta')}
                </Button>
              </div>
            </CardContent>
          </Card>
        </Link>

        {/* AI Coach Card - NEW */}
        <Link href="/ai-coach">
          <Card className="bg-gradient-to-br from-blue-500/10 to-purple-500/10 border-blue-500/30 cursor-pointer hover-elevate active-elevate-2" data-testid="card-ai-coach">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-full bg-blue-500/20">
                    <MessageCircle className="w-5 h-5 text-blue-600 dark:text-blue-400" />
                  </div>
                  <div>
                    <p className="text-sm font-medium text-foreground">{t('dashboard:ai_coach.title')}</p>
                    <p className="text-xs text-muted-foreground">{t('dashboard:ai_coach.subtitle')}</p>
                  </div>
                </div>
                <Button 
                  size="sm" 
                  variant="secondary"
                  className="pointer-events-none"
                  data-testid="button-ai-coach-cta"
                >
                  {t('dashboard:ai_coach.cta')}
                </Button>
              </div>
            </CardContent>
          </Card>
        </Link>

        {/* Protein Powder Quick Add - Plus Feature */}
        <ProteinPowderQuickAdd />

        {/* Weight Check-in Reminder */}
        {!todayWeight && (
          <Card className="bg-yellow-500/10 border-yellow-500/30" data-testid="card-weight-reminder">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="p-2 rounded-full bg-yellow-500/20">
                    <Scale className="w-5 h-5 text-yellow-600" />
                  </div>
                  <div>
                    <p className="text-sm font-medium text-foreground">记录今日体重</p>
                    <p className="text-xs text-muted-foreground">保持每日记录，追踪进度趋势</p>
                  </div>
                </div>
                <Button 
                  size="sm" 
                  onClick={() => setShowWeightModal(true)}
                  data-testid="button-log-weight"
                >
                  记录
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* TDEE & Remaining Summary Card - NEW: More prominent display */}
        <Card className="border-primary/20 bg-gradient-to-br from-primary/5 to-primary/10">
          <CardContent className="p-5 space-y-4">
            {/* TDEE Display - Large and prominent */}
            <div className="bg-background/60 backdrop-blur rounded-xl p-4 border border-border/50">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-sm font-medium text-muted-foreground">今日目标热量 (TDEE)</h3>
                <Badge variant="outline" className="text-xs">
                  {profile?.goal === 'cut' ? '减脂' : profile?.goal === 'bulk' ? '增肌' : '维持'}
                </Badge>
              </div>
              <div className="flex items-baseline gap-2">
                <span className="text-4xl font-bold text-foreground font-mono">
                  {target.kcal}
                </span>
                <span className="text-xl text-muted-foreground">kcal</span>
              </div>
              <div className="mt-2 text-xs text-muted-foreground">
                {profile?.goal === 'cut' && '基础代谢 × 活动系数 - 400 (减脂缺口)'}
                {profile?.goal === 'bulk' && '基础代谢 × 活动系数 + 300 (增肌盈余)'}
                {profile?.goal === 'maintain' && '基础代谢 × 活动系数 (维持体重)'}
              </div>
            </div>

            {/* Remaining Calories - Extra prominent */}
            <div className="bg-background/60 backdrop-blur rounded-xl p-4 border-2 border-primary/30">
              <h3 className="text-sm font-semibold text-foreground flex items-center gap-2 mb-3">
                <Sparkles className="w-4 h-4 text-primary" />
                {t('dashboard:remainingNutrition')}
              </h3>
              
              <div className="grid grid-cols-2 gap-3">
                <div className="text-center p-4 rounded-lg bg-gradient-to-br from-primary/10 to-primary/5 border border-primary/20">
                  <div className="text-xs text-muted-foreground mb-1">{t('common:nutrients.calories')}</div>
                  <div className="font-mono text-2xl font-bold text-primary">
                    {remaining.kcal > 0 ? remaining.kcal.toFixed(0) : 0}
                  </div>
                  <div className="text-xs text-muted-foreground mt-1">
                    还剩 {remaining.kcal > 0 ? ((remaining.kcal / target.kcal) * 100).toFixed(0) : 0}%
                  </div>
                </div>
              
                <div className="text-center p-3 rounded-lg bg-background/50">
                  <div className="text-xs text-muted-foreground mb-1">{t('common:nutrients.protein')}</div>
                  <div className="font-mono text-lg font-semibold text-foreground">
                    {remaining.proteinG > 0 ? remaining.proteinG.toFixed(1) : 0}
                  </div>
                  <div className="text-xs text-muted-foreground">g</div>
                </div>
                
                <div className="text-center p-3 rounded-lg bg-background/50">
                  <div className="text-xs text-muted-foreground mb-1">{t('common:nutrients.fat')}</div>
                  <div className="font-mono text-lg font-semibold text-foreground">
                    {remaining.fatG > 0 ? remaining.fatG.toFixed(1) : 0}
                  </div>
                  <div className="text-xs text-muted-foreground">g</div>
                </div>
                
                <div className="text-center p-3 rounded-lg bg-background/50">
                  <div className="text-xs text-muted-foreground mb-1">{t('common:nutrients.carbs')}</div>
                  <div className="font-mono text-lg font-semibold text-foreground">
                    {remaining.carbsG > 0 ? remaining.carbsG.toFixed(1) : 0}
                  </div>
                  <div className="text-xs text-muted-foreground">g</div>
                </div>
              </div>
            </div>
            
            <div className="space-y-2">
              <Button 
                className="w-full h-12 text-base font-semibold"
                size="lg"
                onClick={handleFillRemaining}
                disabled={suggestMutation.isPending || remaining.kcal <= 0}
                data-testid="button-fill-remaining"
              >
                {suggestMutation.isPending ? (
                  <>
                    <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                    生成中...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-5 h-5 mr-2" />
                    一键补足剩余营养
                    {isPro && (
                      <Badge variant="secondary" className="ml-2 text-xs">PRO</Badge>
                    )}
                  </>
                )}
              </Button>
              {!isPro && (
                <p className="text-xs text-muted-foreground text-center">
                  今日已使用 {dailyAIUsage}/3 次 • <Link href="/upgrade-pro" className="text-primary hover:underline">升级 PRO 解锁无限使用</Link>
                </p>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Calorie Ring */}
        <div className="flex justify-center">
          <CircularProgress
            current={current.kcal}
            target={target.kcal}
            size={192}
            strokeWidth={12}
            label={t('common:nutrients.calories')}
            unit="kcal"
            color="hsl(var(--chart-1))"
          />
        </div>

        {/* Macro Bars */}
        <div className="space-y-3">
          <MacroBar
            icon={Beef}
            label={t('common:nutrients.protein')}
            current={current.proteinG}
            target={target.proteinG}
            unit="g"
            color="hsl(var(--chart-1))"
            iconColor="text-chart-1"
          />
          
          <MacroBar
            icon={Flame}
            label={t('common:nutrients.fat')}
            current={current.fatG}
            target={target.fatG}
            unit="g"
            color="hsl(var(--chart-4))"
            iconColor="text-chart-4"
          />
          
          <MacroBar
            icon={Wheat}
            label={t('common:nutrients.carbs')}
            current={current.carbsG}
            target={target.carbsG}
            unit="g"
            color="hsl(var(--chart-2))"
            iconColor="text-chart-2"
          />
          
          <MacroBar
            icon={Apple}
            label={t('common:nutrients.fiber')}
            current={current.fiberG}
            target={target.fiberG}
            unit="g"
            color="hsl(var(--chart-3))"
            iconColor="text-chart-3"
          />
          
          <MacroBar
            icon={Droplets}
            label={t('common:nutrients.water')}
            current={current.waterOz}
            target={target.waterOz}
            unit="oz"
            color="hsl(var(--chart-2))"
            iconColor="text-chart-2"
          />
        </div>

        {/* Micronutrients Collapsible Panel */}
        <Collapsible open={showMicronutrients} onOpenChange={setShowMicronutrients}>
          <Card className="border-muted">
            <CardContent className="p-0">
              <CollapsibleTrigger className="w-full p-4 flex items-center justify-between hover-elevate" data-testid="button-toggle-micronutrients">
                <div className="flex items-center gap-2">
                  <h3 className="text-sm font-semibold text-foreground">{t('dashboard:micronutrients')}</h3>
                  <Badge variant="outline" className="text-xs">12</Badge>
                </div>
                {showMicronutrients ? (
                  <ChevronUp className="w-4 h-4 text-muted-foreground" />
                ) : (
                  <ChevronDown className="w-4 h-4 text-muted-foreground" />
                )}
              </CollapsibleTrigger>
              
              <CollapsibleContent>
                <div className="px-4 pb-4 space-y-3 border-t border-border pt-4">
                  {/* Vitamins Section */}
                  <div className="space-y-2">
                    <h4 className="text-xs font-medium text-muted-foreground uppercase tracking-wide">{t('dashboard:vitamins')}</h4>
                    
                    {/* Vitamin A */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:vitaminA')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.vitaminAMcg || 0).toFixed(0)} / {(target.vitaminAMcg || 900).toFixed(0)} mcg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.vitaminAMcg || 0) / (target.vitaminAMcg || 900)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.vitaminAMcg || 0) / (target.vitaminAMcg || 900)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Vitamin C */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:vitaminC')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.vitaminCMg || 0).toFixed(0)} / {(target.vitaminCMg || 90).toFixed(0)} mg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.vitaminCMg || 0) / (target.vitaminCMg || 90)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.vitaminCMg || 0) / (target.vitaminCMg || 90)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Vitamin D */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:vitaminD')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.vitaminDMcg || 0).toFixed(1)} / {(target.vitaminDMcg || 15).toFixed(0)} mcg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.vitaminDMcg || 0) / (target.vitaminDMcg || 15)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.vitaminDMcg || 0) / (target.vitaminDMcg || 15)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Vitamin E */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:vitaminE')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.vitaminEMg || 0).toFixed(1)} / {(target.vitaminEMg || 15).toFixed(0)} mg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.vitaminEMg || 0) / (target.vitaminEMg || 15)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.vitaminEMg || 0) / (target.vitaminEMg || 15)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Vitamin K */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:vitaminK')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.vitaminKMcg || 0).toFixed(0)} / {(target.vitaminKMcg || 120).toFixed(0)} mcg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.vitaminKMcg || 0) / (target.vitaminKMcg || 120)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.vitaminKMcg || 0) / (target.vitaminKMcg || 120)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Vitamin B12 */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:vitaminB12')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.vitaminB12Mcg || 0).toFixed(1)} / {(target.vitaminB12Mcg || 2.4).toFixed(1)} mcg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.vitaminB12Mcg || 0) / (target.vitaminB12Mcg || 2.4)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.vitaminB12Mcg || 0) / (target.vitaminB12Mcg || 2.4)) * 100).toFixed(0)}%
                      </p>
                    </div>
                  </div>

                  {/* Minerals Section */}
                  <div className="space-y-2 pt-3 border-t border-border">
                    <h4 className="text-xs font-medium text-muted-foreground uppercase tracking-wide">{t('dashboard:minerals')}</h4>
                    
                    {/* Calcium */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:calcium')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.calciumMg || 0).toFixed(0)} / {(target.calciumMg || 1000).toFixed(0)} mg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.calciumMg || 0) / (target.calciumMg || 1000)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.calciumMg || 0) / (target.calciumMg || 1000)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Iron */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:iron')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.ironMg || 0).toFixed(1)} / {(target.ironMg || 8).toFixed(0)} mg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.ironMg || 0) / (target.ironMg || 8)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.ironMg || 0) / (target.ironMg || 8)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Magnesium */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:magnesium')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.magnesiumMg || 0).toFixed(0)} / {(target.magnesiumMg || 400).toFixed(0)} mg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.magnesiumMg || 0) / (target.magnesiumMg || 400)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.magnesiumMg || 0) / (target.magnesiumMg || 400)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Zinc */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:zinc')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.zincMg || 0).toFixed(1)} / {(target.zincMg || 11).toFixed(0)} mg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.zincMg || 0) / (target.zincMg || 11)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.zincMg || 0) / (target.zincMg || 11)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Potassium */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground">{t('dashboard:potassium')}</span>
                        <span className="font-mono text-muted-foreground">
                          {(current.potassiumMg || 0).toFixed(0)} / {(target.potassiumMg || 3400).toFixed(0)} mg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.potassiumMg || 0) / (target.potassiumMg || 3400)) * 100)} 
                        className="h-1.5"
                      />
                      <p className="text-xs text-muted-foreground">
                        {(((current.potassiumMg || 0) / (target.potassiumMg || 3400)) * 100).toFixed(0)}%
                      </p>
                    </div>

                    {/* Sodium (Upper Limit) */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-foreground flex items-center gap-1">
                          {t('dashboard:sodium')}
                          <Badge variant="outline" className="text-[10px] px-1 py-0">{t('dashboard:upperLimit')}</Badge>
                        </span>
                        <span className="font-mono text-muted-foreground">
                          {(current.sodiumMg || 0).toFixed(0)} / {(target.sodiumMg || 2300).toFixed(0)} mg
                        </span>
                      </div>
                      <Progress 
                        value={Math.min(100, ((current.sodiumMg || 0) / (target.sodiumMg || 2300)) * 100)} 
                        className={`h-1.5 ${((current.sodiumMg || 0) / (target.sodiumMg || 2300)) >= 1 ? '[&>div]:bg-destructive' : ''}`}
                      />
                      <p className={`text-xs ${((current.sodiumMg || 0) / (target.sodiumMg || 2300)) >= 1 ? 'text-destructive font-medium' : 'text-muted-foreground'}`}>
                        {(((current.sodiumMg || 0) / (target.sodiumMg || 2300)) * 100).toFixed(0)}%
                        {((current.sodiumMg || 0) / (target.sodiumMg || 2300)) >= 1 && ` ${t('dashboard:exceedsLimit')}`}
                        {((current.sodiumMg || 0) / (target.sodiumMg || 2300)) < 1 && ` ${t('dashboard:stayBelowLimit')}`}
                      </p>
                    </div>
                  </div>
                </div>
              </CollapsibleContent>
            </CardContent>
          </Card>
        </Collapsible>

        {/* Advertisement Banner - Free users only */}
        <AdBanner position="bottom" className="mt-8" />
      </main>

      {/* AI Suggestions Dialog */}
      <Dialog open={showSuggestions} onOpenChange={handleDialogOpenChange}>
        <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <div className="flex items-center justify-between gap-3">
              <div className="flex-1">
                <DialogTitle className="flex items-center gap-2">
                  <Sparkles className="w-5 h-5 text-primary" />
                  AI 推荐组合
                </DialogTitle>
                <DialogDescription>
                  基于剩余营养需求,为你推荐以下饮食组合
                </DialogDescription>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={handleRegenerateSuggestions}
                disabled={!isPro || suggestMutation.isPending}
                data-testid="button-regenerate-suggestions"
                className="flex-shrink-0"
              >
                {suggestMutation.isPending ? (
                  <>
                    <Loader2 className="w-3.5 h-3.5 mr-1.5 animate-spin" />
                    生成中
                  </>
                ) : (
                  <>
                    <RefreshCw className="w-3.5 h-3.5 mr-1.5" />
                    换一组
                    {!isPro && (
                      <Badge variant="secondary" className="ml-1.5 text-xs">PRO</Badge>
                    )}
                  </>
                )}
              </Button>
            </div>
          </DialogHeader>
          
          <div className="space-y-4 mt-4">
            {suggestions.map((combo, idx) => (
              <Card key={idx} className="border-primary/20">
                <CardContent className="p-4 space-y-3">
                  <h3 className="font-semibold text-base text-foreground">{combo.name}</h3>
                  
                  <div className="space-y-2">
                    {combo.foods.map((food, fidx) => (
                      <div key={fidx} className="flex justify-between items-start gap-3 p-2 rounded-md bg-muted/50">
                        <div className="flex-1">
                          <p className="font-medium text-sm text-foreground">{food.foodName}</p>
                          <p className="text-xs text-muted-foreground">{food.reason}</p>
                        </div>
                        <div className="text-right flex-shrink-0">
                          <div className="font-mono text-sm font-semibold text-foreground">{food.amountG}g</div>
                          <div className="text-xs text-muted-foreground">{food.kcal} kcal</div>
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  <div className="grid grid-cols-3 gap-2 pt-2 border-t">
                    <div className="text-center p-2 rounded-md bg-green-500/10">
                      <div className="text-xs text-muted-foreground">总热量</div>
                      <div className="font-mono text-base font-semibold text-foreground">
                        {combo.totalKcal.toFixed(0)} kcal
                      </div>
                      <div className="text-xs text-muted-foreground">
                        ({combo.deviation.kcal > 0 ? '+' : ''}{combo.deviation.kcal.toFixed(0)})
                      </div>
                    </div>
                    <div className="text-center p-2 rounded-md bg-orange-500/10">
                      <div className="text-xs text-muted-foreground">蛋白质</div>
                      <div className="font-mono text-base font-semibold text-foreground">
                        {combo.totalProteinG.toFixed(1)}g
                      </div>
                      <div className="text-xs text-muted-foreground">
                        ({combo.deviation.proteinG > 0 ? '+' : ''}{combo.deviation.proteinG.toFixed(1)}g)
                      </div>
                    </div>
                    <div className="text-center p-2 rounded-md bg-blue-500/10">
                      <div className="text-xs text-muted-foreground">脂肪</div>
                      <div className="font-mono text-base font-semibold text-foreground">
                        {combo.totalFatG.toFixed(1)}g
                      </div>
                      <div className="text-xs text-muted-foreground">
                        ({combo.deviation.fatG > 0 ? '+' : ''}{combo.deviation.fatG.toFixed(1)}g)
                      </div>
                    </div>
                    <div className="text-center p-2 rounded-md bg-purple-500/10">
                      <div className="text-xs text-muted-foreground">碳水</div>
                      <div className="font-mono text-base font-semibold text-foreground">
                        {combo.totalCarbsG.toFixed(1)}g
                      </div>
                      <div className="text-xs text-muted-foreground">
                        ({combo.deviation.carbsG > 0 ? '+' : ''}{combo.deviation.carbsG.toFixed(1)}g)
                      </div>
                    </div>
                    <div className="text-center p-2 rounded-md bg-amber-500/10 col-span-2">
                      <div className="text-xs text-muted-foreground">纤维</div>
                      <div className="font-mono text-base font-semibold text-foreground">
                        {combo.totalFiberG.toFixed(1)}g
                      </div>
                      <div className="text-xs text-muted-foreground">
                        (剩余 {Math.max(0, (summary?.remaining.fiberG || 0)).toFixed(1)}g)
                      </div>
                    </div>
                  </div>
                  
                  <Button 
                    className="w-full mt-3" 
                    onClick={() => logComboMutation.mutate(combo)}
                    disabled={logComboMutation.isPending}
                    data-testid={`button-log-combo-${idx}`}
                  >
                    {logComboMutation.isPending ? (
                      <>
                        <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                        记录中...
                      </>
                    ) : (
                      '一键记录此组合'
                    )}
                  </Button>
                </CardContent>
              </Card>
            ))}
          </div>
        </DialogContent>
      </Dialog>

      {/* Weight Input Modal */}
      <Dialog open={showWeightModal} onOpenChange={setShowWeightModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <Scale className="w-5 h-5 text-primary" />
              记录今日体重
            </DialogTitle>
            <DialogDescription>
              输入您的当前体重，追踪体重变化趋势
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4 mt-4">
            <div className="space-y-2">
              <Label htmlFor="weight-input">体重</Label>
              <div className="flex gap-2">
                <Input
                  id="weight-input"
                  type="number"
                  step="0.1"
                  min="0"
                  placeholder={weightUnit === "kg" ? "输入公斤数..." : "输入磅数..."}
                  value={weightInput}
                  onChange={(e) => setWeightInput(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      handleLogWeight();
                    }
                  }}
                  data-testid="input-weight"
                  className="flex-1"
                />
                <Select
                  value={weightUnit}
                  onValueChange={(value: "lb" | "kg") => setWeightUnit(value)}
                >
                  <SelectTrigger className="w-24" data-testid="select-weight-unit">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="lb">磅 (lb)</SelectItem>
                    <SelectItem value="kg">公斤 (kg)</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              {weightInput && (
                <p className="text-xs text-muted-foreground">
                  {weightUnit === "kg" 
                    ? `≈ ${(parseFloat(weightInput) * 2.20462).toFixed(1)} lb`
                    : `≈ ${(parseFloat(weightInput) / 2.20462).toFixed(1)} kg`
                  }
                </p>
              )}
            </div>

            <div className="flex gap-2 pt-2">
              <Button
                variant="outline"
                className="flex-1"
                onClick={() => setShowWeightModal(false)}
                data-testid="button-cancel-weight"
              >
                取消
              </Button>
              <Button
                className="flex-1"
                onClick={handleLogWeight}
                disabled={logWeightMutation.isPending || !weightInput}
                data-testid="button-submit-weight"
              >
                {logWeightMutation.isPending ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    记录中...
                  </>
                ) : (
                  '确认记录'
                )}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
