0）准备（一次性）

在 Stripe 后台创建商品 FitMeal Full Access，月付价格 $14.99；拿到 PRICE_ID。

在项目变量里填好：

STRIPE_SECRET_KEY = sk_live_or_test_xxx

STRIPE_PRICE_ID = price_xxx（上一步拿到）

STRIPE_ENDPOINT_SECRET = whsec_xxx（Stripe Webhook 里的 Signing secret）

APP_URL = https://你的域名

1）数据表改动（直接执行）
ALTER TABLE users
  ADD COLUMN stripe_customer_id text,
  ADD COLUMN stripe_subscription_id text,
  ADD COLUMN subscription_status text,
  ADD COLUMN subscription_current_period_end timestamptz,
  ADD COLUMN subscription_trial_end timestamptz,
  ADD COLUMN payment_fingerprint text;

2）订阅入口（按钮 + 接口）

在“订阅/定价”页面保留单一卡片：
标题：试用7天 → 之后 $14.99/月（全部功能解锁）
按钮：开始试用

点击“开始试用”时：

调用接口：POST /api/create-checkout-session

返回 { sessionId } 后，重定向到 Stripe Checkout：stripe.redirectToCheckout({ sessionId })

接口要求：
/api/create-checkout-session 完成的事情：

若当前用户没有 stripe_customer_id：在 Stripe 创建一个 customer（email = 用户邮箱，metadata.userId = 用户ID），写回 stripe_customer_id。

创建 Checkout Session：mode=subscription，line_items=[{price: STRIPE_PRICE_ID, quantity:1}]，subscription_data.trial_period_days=7，success_url=${APP_URL}/billing/success?session_id={CHECKOUT_SESSION_ID}，cancel_url=${APP_URL}/billing/cancel}。

返回 { sessionId }。

3）Stripe Webhook（唯一入口，必须生效）

路由：POST /api/webhooks/stripe，用 STRIPE_ENDPOINT_SECRET 校验签名。

处理以下事件（只做这些）：

checkout.session.completed：拿到 session.customer（或 email 映射到用户），记下 stripe_subscription_id，写 subscription_status = 'trialing' 与 subscription_trial_end（从 subscription 上读 trial_end）。

invoice.payment_succeeded：读取 subscription.latest_invoice -> payment_intent -> payment_method，取得 card.fingerprint：

在表里搜是否已有同一 payment_fingerprint 且 subscription_status in ('active','trialing') 的其他用户。

若有：取消本次新订阅（stripe.subscriptions.del(subscriptionId)），记录冲突标记（可在备注表或日志里），给用户展示“支付卡已绑定在另一个账号，如需转移请联系客服”。

若无：把该 payment_fingerprint 写入当前用户行。然后把 subscription_status = 'active'，更新 subscription_current_period_end。

customer.subscription.updated：同步 subscription_status（active / canceled / past_due / trialing），与新的 current_period_end。

customer.subscription.deleted：把 subscription_status='canceled'，清空 stripe_subscription_id（可选）。

备注：试用期有时没有真实 payment_method，此时只要维持 trialing 状态，等首次扣费成功再写入 payment_fingerprint。

4）访问控制（解锁逻辑）

所有“需要订阅”的功能统一判定：当且仅当 subscription_status in ('active','trialing') → 允许；否则弹出订阅卡片。

登录之后，拉一次 /api/me（或等价查询）拿到 subscription_status，在全局状态里缓存。

Billing 页面显示：

订阅状态（trialing/active/canceled）

试用结束时间（trialing 时显示）

下一扣款日（active 时显示）

“取消订阅”按钮（调用 /api/subscription/cancel）

/api/subscription/cancel 要求：

读取用户的 stripe_subscription_id，调用 Stripe：update(subscriptionId, { cancel_at_period_end: true })；回写 subscription_status='cancel_at_period_end'。

显示文案：“已安排在当前计费期末取消，可在此之前随时恢复。”

/api/subscription/resume（可选）：

若 cancel_at_period_end=true：调用 update(subscriptionId, { cancel_at_period_end: false })；状态回写。

5）定价/页面统一（只保留一种）

移除 Free/Plus/Pro 的三栏展示。

统一显示：

试用7天 → 之后 $14.99/月，随时取消

小字：试用内取消不收费；若同一张支付卡已在其他账号激活订阅，新订阅将被阻止，如需转移请联系客服。

登录方式保持现有（邮箱/Google/Apple皆可）。不做 IP 限制。

6）验收清单（必须全部通过）

新账号 → 点击“开始试用” → 跳到 Stripe → 完成流程 → 返回 “成功”页：

数据里 subscription_status='trialing'，subscription_trial_end 有值。

试用到期后首次扣款成功（可用 Stripe 测试时钟/测试卡模拟）：

收到 invoice.payment_succeeded → subscription_status='active'，subscription_current_period_end 更新。

用同一张卡再次在另一个账号“开始试用/订阅”：

webhook 检测到已有 payment_fingerprint → 取消新订阅，旧订阅保持；在日志里记录“重复卡拦截”。

取消订阅：

点击“取消订阅”→ 状态变 cancel_at_period_end，并在 Stripe 上看到该标记；到期后变 canceled。

恢复订阅（可选）：

在期末前点击“恢复”，标记取消；状态回到 active。

未订阅用户触发受限功能：

一律弹出订阅卡片并引导“开始试用”。

登录后任意页面都能正确显示当前订阅状态（trialing/active/canceled）。

7）错误与提示（统一口径）

重复卡拦截：提示
这张支付卡已绑定另一个活跃订阅。如需把订阅迁移到本账号，请联系支持。

试用说明：
试用 7 天内取消不收费；试用结束将自动按 $14.99/月续订，可随时取消。