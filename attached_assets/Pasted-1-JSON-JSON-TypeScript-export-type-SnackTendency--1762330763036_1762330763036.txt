1) ç»Ÿä¸€è¿”å›æ•°æ®ç»“æ„ï¼ˆå¼ºåˆ¶ JSONï¼‰

ç›®çš„ï¼šä¸è¦å†ç”¨å¤§æ®µæ–‡æœ¬ï¼›åªæ¥å—ä¸¥æ ¼ JSONã€‚å¦åˆ™å°±æ‹’æ”¶å¹¶é‡è¯•ã€‚

TypeScript æ¥å£ï¼š

export type SnackTendency = 'Craving Sweet' | 'Craving Crunchy';

export interface SnackRecommendation {
  tendency: SnackTendency;                 // 'Craving Sweet' | 'Craving Crunchy'
  title: string;                           // å¦‚ï¼šGreek yogurt with berries
  calories_kcal: number;                   // 50-350 ä¹‹é—´çš„æ•´æ•°
  protein_g: number;                       // 0-60
  carbs_g: number;                         // 0-80
  fat_g: number;                           // 0-40
  why: string;                             // 1-2 å¥è¯è§£é‡Š
  swaps: string[];                         // 2-3 ä¸ªæ›¿ä»£/å˜ä½“
  notes: string[];                         // 1-3 æ¡æ³¨æ„ç‚¹ï¼ˆå¦‚ä»½é‡ã€ç»„åˆå»ºè®®ï¼‰
}

export interface SnackResponse {
  date: string;                            // YYYY-MM-DD
  items: SnackRecommendation[];            // æ°å¥½ä¸¤ä¸ªï¼šSweet & Crunchy
}

2) OpenAI è°ƒç”¨ï¼šåªè¦ JSONï¼Œä¸è¦åˆ«çš„

ç³»ç»ŸæŒ‡ä»¤ï¼ˆsystemï¼‰ï¼š

You are a registered dietitian. Return structured snack recommendations as strict JSON only. No prose, no explanations. Macros must be realistic and consistent. calories_kcal must match 4protein_g + 4carbs_g + 9*fat_g Â±5%. Ranges: calories 50-350, protein 0-60g, carbs 0-80g, fat 0-40g. Provide exactly two items: one "Craving Sweet" and one "Craving Crunchy".

ç”¨æˆ·æŒ‡ä»¤ï¼ˆuserï¼‰ï¼ˆç¤ºä¾‹ï¼Œå¯æŠŠç”¨æˆ·ä¿¡æ¯å˜é‡åŒ–ï¼‰ï¼š

Generate snack recommendations for:
- goal: maintain weight
- daily target: 2000 kcal
- meal plan already covers ~1650-1750 kcal
- cuisine preference: Chinese + simple continental
- avoid: none
- context: between-meal snacks only (not full meals)

Output format: strict JSON that conforms to this TypeScript type:
SnackResponse { date: 'YYYY-MM-DD', items: SnackRecommendation[] }

Rules:
- Provide EXACTLY two items: one with tendency="Craving Sweet", one with tendency="Craving Crunchy".
- calories_kcal must be between 50 and 350.
- Ensure calories_kcal â‰ˆ 4*protein_g + 4*carbs_g + 9*fat_g (Â±5%).
- Make items feasible in US supermarkets / common Chinese groceries.
- Keep titles short, swaps 2~3 entries, notes 1~3 entries.
- NO extra keys, NO comments. JSON ONLY.


OpenAI è°ƒç”¨ä»£ç ï¼ˆNode/TSï¼‰ï¼š

import OpenAI from 'openai';
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! });

export async function getSnackJSON(prompt: string) {
  const res = await openai.responses.create({
    model: process.env.OPENAI_MODEL ?? 'gpt-4o-mini',
    input: prompt,
    temperature: 0.3,
    // å¼ºåˆ¶è¿”å› JSON å¯¹è±¡
    response_format: { type: 'json_object' },
  });

  const text = res.output_text; // SDK ä¼šç»™å‡ºçº¯æ–‡æœ¬çš„ JSON å­—ç¬¦ä¸²
  return JSON.parse(text);
}

3) åç«¯æ ¡éªŒï¼ˆZod éªŒè¯ + å…œåº•ï¼‰
import { z } from 'zod';

const SnackSchema = z.object({
  date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  items: z.array(z.object({
    tendency: z.enum(['Craving Sweet', 'Craving Crunchy']),
    title: z.string().min(2).max(80),
    calories_kcal: z.number().int().min(50).max(350),
    protein_g: z.number().min(0).max(60),
    carbs_g: z.number().min(0).max(80),
    fat_g: z.number().min(0).max(40),
    why: z.string().min(8),
    swaps: z.array(z.string()).min(1).max(4),
    notes: z.array(z.string()).min(0).max(4),
  })).length(2),
});

function kcalFromMacros(p: number, c: number, f: number) {
  return Math.round(p * 4 + c * 4 + f * 9);
}

export async function generateSnacksOrFallback(userPrompt: string) {
  try {
    const data = await getSnackJSON(userPrompt);
    const parsed = SnackSchema.parse(data);

    // ä¸€è‡´æ€§æ ¡éªŒï¼šçƒ­é‡ä¸å®
    parsed.items = parsed.items.map(item => {
      const calc = kcalFromMacros(item.protein_g, item.carbs_g, item.fat_g);
      // å¦‚æœç›¸å·®å¤§äº Â±5%ï¼Œä»¥å®ä¸ºå‡†é‡ç®—çƒ­é‡
      const diff = Math.abs(calc - item.calories_kcal);
      if (diff > Math.max(5, Math.round(calc * 0.05))) {
        item.calories_kcal = calc;
      }
      // é¿å… 0 å®å¯¼è‡´ 0kcal
      if (item.calories_kcal < 50) {
        // ç®€å•å…œåº•ï¼šè¡¥ 12g protein + 8g carbsï¼ˆâ‰ˆ 100 kcalï¼‰
        item.protein_g = Math.max(item.protein_g, 12);
        item.carbs_g = Math.max(item.carbs_g, 8);
        item.fat_g = Math.max(item.fat_g, 2);
        item.calories_kcal = kcalFromMacros(item.protein_g, item.carbs_g, item.fat_g);
      }
      return item;
    });

    return parsed;
  } catch (e) {
    // å½»åº•å…œåº•ï¼šè¿”å›ä¸€å¥—ç¡¬ç¼–ç å¯ç”¨é¡¹ï¼Œé¿å… UI å‡ºç° 0/2kcal
    const today = new Date().toISOString().slice(0,10);
    return {
      date: today,
      items: [
        {
          tendency: 'Craving Sweet',
          title: 'Greek yogurt (150g) with blueberries (80g)',
          calories_kcal: 180,
          protein_g: 15,
          carbs_g: 20,
          fat_g: 4,
          why: 'Provides protein and natural sweetness to curb sweet cravings.',
          swaps: ['Low-fat yogurt + strawberries', 'Skyr + sliced apple'],
          notes: ['Keep added sugar â‰¤ 5g', 'Add 5â€“10g nuts if still hungry'],
        },
        {
          tendency: 'Craving Crunchy',
          title: 'Handful of almonds (25g) + baby carrots (100g)',
          calories_kcal: 220,
          protein_g: 7,
          carbs_g: 12,
          fat_g: 16,
          why: 'Crunchy texture with healthy fats for satiety.',
          swaps: ['Walnuts + cucumber sticks', 'Whole-grain crackers + hummus'],
          notes: ['Weigh nuts to avoid excess calories'],
        },
      ],
    } as SnackResponse;
  }
}

4) å‰ç«¯æ¸²æŸ“ä¿®æ­£ï¼ˆç¡®ä¿ä¸ä¼šæ˜¾ç¤º 0/2 kcalï¼‰

æ•°å€¼æ˜¾ç¤ºå‰åš ä¸‹é™ä¿æŠ¤ï¼š

const kcal = Math.max(50, item.calories_kcal | 0);
const p = Math.max(0, Math.round(item.protein_g));
const c = Math.max(0, Math.round(item.carbs_g));
const f = Math.max(0, Math.round(item.fat_g));


å¦‚æœ kcal < 50 æˆ–å…¨éƒ¨å®ä¸º 0ï¼Œä¸è¦æ¸²æŸ“ï¼Œæ˜¾ç¤ºâ€œç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•â€æŒ‰é’®ã€‚

5) è§¦å‘æŒ‰é’®çš„æ–‡æ¡ˆ

æŠŠ â€œAI Snack Recommendationâ€ çš„æç¤ºæ”¹ä¸ºï¼š

â€œè‡ªåŠ¨ç”Ÿæˆä¸¤æ¡å¯æ‰§è¡Œçš„é›¶é£Ÿå»ºè®®ï¼ˆç”œ/è„†å„ä¸€ï¼‰ï¼ŒåŒ…å«çƒ­é‡ä¸ä¸‰å¤§è¥å…»ç´ ã€‚è‹¥ç”Ÿæˆå¼‚å¸¸ä¼šè‡ªåŠ¨ä¿®å¤æˆ–ç»™å‡ºå®‰å…¨å…œåº•é¡¹ã€‚â€

ğŸ”§ è¿™æ¬¡ä¿®å®Œåï¼Œæ•°æ®åº”è¯¥åƒè¿™æ ·ï¼ˆç¤ºä¾‹ï¼‰
{
  "date": "2025-11-05",
  "items": [
    {
      "tendency": "Craving Sweet",
      "title": "Greek yogurt (150g) with blueberries (80g)",
      "calories_kcal": 182,
      "protein_g": 16,
      "carbs_g": 21,
      "fat_g": 3,
      "why": "Protein + natural sweetness helps manage cravings without a big calorie load.",
      "swaps": ["Skyr + raspberries", "Low-fat yogurt + apple slices"],
      "notes": ["Control added sugar â‰¤ 5g", "Add 5â€“10g nuts if you still feel hungry"]
    },
    {
      "tendency": "Craving Crunchy",
      "title": "Almonds (25g) + baby carrots (100g)",
      "calories_kcal": 219,
      "protein_g": 7,
      "carbs_g": 12,
      "fat_g": 16,
      "why": "Crunchy texture with healthy fats increases satiety.",
      "swaps": ["Walnuts + cucumber sticks", "Whole-grain crackers + hummus"],
      "notes": ["Weigh nuts to avoid excess calories"]
    }
  ]
}